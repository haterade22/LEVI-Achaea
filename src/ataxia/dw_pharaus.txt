---- Goal: Stick timeloop → leverage double instills → hypochondria → impatience lock

shadowList = shadowList or {}

function dictate_Threshold()
  
  currentDictateThresh = {}
  local haveThreshAffs = {}
  local threshAffs = {
    "depression",
    "shadowmadness",
    "retribution",
    "parasite",
  }
  
  for _,v in pairs(threshAffs) do 
    if haveAff(v) then
      table.insert(haveThreshAffs, v)
    end
  end
  
  if #haveThreshAffs > 0 then
    currentDictateThresh = (#haveThreshAffs * 5) + 40
  else 
    currentDictateThresh = 40
  end


end
   

function dwAttack()
    local hasShadow = table.contains(shadowList, target)
    local dwAge = ataxiaTables.depthswalker.age
    
    -- Determine weapon setup based on shield status
    if Shielded == true then
        dwPrefix = "setalias att stand::stand::stand::wield left dagger::wipe dagger::wield right shield::"
    else
        dwPrefix = "setalias att stand::stand::stand::wield left scythe::wipe scythe::wield right shield::"
    end
    
    atkstr = dwPrefix
    dictate_Threshold()
    
    -- ATTUNEMENT LOGIC
    -- Attune to madness if they have shadowmadness, otherwise degeneration
    if haveAff("shadowmadness") then
        if theirAttune ~= "madness" then
            atkstr = atkstr.."shadow attune "..target.." to MADNESS/"
        end
    else
        if theirAttune ~= "degeneration" then
            atkstr = atkstr.."shadow attune "..target.." to DEGENERATION/"
        end
    end
    
    -- KILL CONDITIONS (always check first)
    if ataxiaTemp.lastAssess <= 55 and ataxiaTemp.lastAssess >= 41 and hasShadow then
        atkstr = atkstr.."intone tooros::shadow cull "..target.." curare::assess "..target.."::contemplate "..target
        send("setalias att "..atkstr)
        send("queue addclear freestand att")
        return
    elseif ataxiaTemp.lastAssess <= 40 and hasShadow then
        atkstr = atkstr.."wield right dagger::intone tooros::shadow mutilate "..target.." curare::assess "..target.."::contemplate "..target
        send("setalias att "..atkstr)
        send("queue addclear freestand att")
        return
    elseif theirMana <= 65 and hasShadow then
        atkstr = atkstr.."wield right dagger::intone tooros::shadow mutilate "..target.." curare::assess "..target.."::contemplate "..target
        send("setalias att "..atkstr)
        send("queue addclear freestand att")
        return
    elseif theirMana <= currentDictateThresh then
        atkstr = atkstr.."shadow dictate "..target.."::contemplate "..target
        send("setalias att "..atkstr)
        send("queue addclear freestand att")
        return
    elseif Shielded then
        atkstr = atkstr.."shadow strike "..target.."::assess "..target.."::contemplate "..target
        send("setalias att "..atkstr)
        send("queue addclear freestand att")
        return
    end
    
    -- MAIN AFFLICTION PROGRESSION
    local instill = ""
    local venom = ""
    local useLoop = false
    local loopBoost = false
    
    -- Check key progression markers
    local hasTimeloop = haveAff("timeloop")
    local hasClumsy = haveAff("clumsiness")
    local hasWeariness = haveAff("weariness")
    local hasParalysis = haveAff("paralysis")
    local hasJustice = haveAff("justice")
    local hasRetribution = haveAff("retribution")
    local hasDepression = haveAff("depression")
    local hasNausea = haveAff("nausea")
    local hasHypochondria = haveAff("hypochondria")
    local hasShadowmadness = haveAff("shadowmadness")
    local hasImpatience = haveAff("impatience")
    local hasAsthma = haveAff("asthma")
    local hasSlickness = haveAff("slickness")
    local hasAnorexia = haveAff("anorexia")
    
    -- Age check for loop capabilities
    local canBoost = (dwAge == 0)
    local canLoop = (dwAge < 350)
    
    -- checkLoop override: if we're uncertain about timeloop status, don't apply loop
    -- Instead progress with venom/instill to confirm status via triggers
    local uncertainLoop = (checkLoop == true)
    
    -- PROGRESSION LOGIC
    
    -- CRITICAL: If we've progressed past initial setup but lost timeloop, reapply with appropriate instill
    -- Only exception: if we're in final lock mode with impatience/shadowmadness
    -- If uncertain about loop status (checkLoop = true), we still need to check if we should be trying to reapply
    if not hasTimeloop and not hasImpatience and not hasShadowmadness and canLoop then
        -- Determine which phase we're in and reapply loop appropriately
        -- BUT if uncertainLoop = true, we'll use venom instead of loop to check status first
        if hasHypochondria then
            -- In madness phase - reapply loop with madness (or check with venom if uncertain)
            instill = "madness"
            if not uncertainLoop then
                useLoop = true
                loopBoost = canBoost
                venom = ""
            else
                -- Uncertain - use venom to check
                if not hasAsthma then
                    venom = "kalmia"
                elseif not hasWeariness then
                    venom = "vernalius"
                elseif not hasSlickness then
                    venom = "gecko"
                elseif not hasAnorexia then
                    venom = "slike"
                else
                    venom = "eurypteria"
                end
            end
            if useLoop and loopBoost then
                atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop boost::shadow reap "..target.."::assess "..target.."::contemplate "..target
            elseif useLoop then
                atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop::shadow reap "..target.."::assess "..target.."::contemplate "..target
            else
                atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
            end
            send("setalias att "..atkstr)
            send("queue addclear freestand att")
            return
        elseif hasJustice and hasRetribution then
            -- Have both justice + retribution, moved to depression phase
            -- Reapply loop with degeneration (need clum+wear for this)
            if hasClumsy and hasWeariness then
                instill = "degeneration"
                if not uncertainLoop then
                    useLoop = true
                    loopBoost = canBoost
                    venom = ""
                else
                    -- Uncertain - use venom to check
                    venom = "curare"
                end
                if useLoop and loopBoost then
                    atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop boost::shadow reap "..target.."::assess "..target.."::contemplate "..target
                elseif useLoop then
                    atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop::shadow reap "..target.."::assess "..target.."::contemplate "..target
                else
                    atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
                end
                send("setalias att "..atkstr)
                send("queue addclear freestand att")
                return
            else
                -- Lost clum/wear, need to rebuild them first
                instill = "degeneration"
                venom = "curare"
                atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
                send("setalias att "..atkstr)
                send("queue addclear freestand att")
                return
            end
        elseif hasJustice or hasRetribution then
            -- In retribution phase - reapply loop with retribution (or check with venom if uncertain)
            instill = "retribution"
            if not uncertainLoop then
                useLoop = true
                loopBoost = canBoost
                venom = ""
            else
                -- Uncertain - use venom to check
                venom = "curare"
            end
            if useLoop and loopBoost then
                atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop boost::shadow reap "..target.."::assess "..target.."::contemplate "..target
            elseif useLoop then
                atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop::shadow reap "..target.."::assess "..target.."::contemplate "..target
            else
                atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
            end
            send("setalias att "..atkstr)
            send("queue addclear freestand att")
            return
        elseif hasDepression or hasNausea then
            -- Started depression but lost timeloop
            -- Reapply with degeneration if possible
            if hasClumsy and hasWeariness then
                instill = "degeneration"
                if not uncertainLoop then
                    useLoop = true
                    loopBoost = canBoost
                    venom = ""
                else
                    venom = "curare"
                end
                if useLoop and loopBoost then
                    atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop boost::shadow reap "..target.."::assess "..target.."::contemplate "..target
                elseif useLoop then
                    atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop::shadow reap "..target.."::assess "..target.."::contemplate "..target
                else
                    atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
                end
                send("setalias att "..atkstr)
                send("queue addclear freestand att")
                return
            else
                -- Rebuild clum/wear
                instill = "degeneration"
                venom = "curare"
                atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
                send("setalias att "..atkstr)
                send("queue addclear freestand att")
                return
            end
        end
    end
    
    -- Lock mode: impatience is present
    if hasImpatience then
        -- Complete the lock: para, asthma, weariness, slickness, anorexia, impatience
        -- Maintain hypochondria, opportunistically use degeneration for capstone
        if hasClumsy and hasWeariness and hasHypochondria then
            instill = "degeneration"
            -- Degen will give paralysis, so venom should progress lock instead
            if not hasAsthma then
                venom = "kalmia"
            elseif not hasSlickness then
                venom = "gecko"
            elseif not hasAnorexia then
                venom = "slike"
            else
                venom = "eurypteria"
            end
        elseif hasHypochondria then
            instill = "depression"
            -- Lock venom priority (can't use curare with depression)
            if not hasAsthma then
                venom = "kalmia"
            elseif not hasWeariness then
                venom = "vernalius"
            elseif not hasSlickness then
                venom = "gecko"
            elseif not hasAnorexia then
                venom = "slike"
            else
                venom = "eurypteria"
            end
        else
            -- Lost hypochondria, rebuild it
            instill = "depression"
            if not hasAsthma then
                venom = "kalmia"
            else
                venom = "gecko"
            end
        end
    
    -- Have shadowmadness: maintain hypochondria, wait for impatience tick
    elseif hasShadowmadness then
        if hasHypochondria then
            -- Maintain while stacking lock affs
            if hasClumsy and hasWeariness then
                instill = "degeneration"
                venom = "curare"  -- Capstone opportunity
            else
                instill = "depression"
                if not hasAsthma then
                    venom = "kalmia"
                elseif not hasSlickness then
                    venom = "gecko"
                elseif not hasAnorexia then
                    venom = "slike"
                else
                    venom = "eurypteria"
                end
            end
        else
            -- Need hypochondria back
            instill = "depression"
            if not hasAsthma then
                venom = "kalmia"
            else
                venom = "gecko"
            end
        end
    
    -- Have hypochondria but not shadowmadness: deliver madness
    elseif hasHypochondria and not hasShadowmadness then
        instill = "madness"
        
        -- If uncertain about loop status, don't apply loop - just use venom to check
        if uncertainLoop then
            if not hasAsthma then
                venom = "kalmia"
            elseif not hasWeariness then
                venom = "vernalius"
            elseif not hasSlickness then
                venom = "gecko"
            elseif not hasAnorexia then
                venom = "slike"
            else
                venom = "eurypteria"
            end
        -- If timeloop dropped, reapply with loop
        elseif not hasTimeloop and canLoop then
            instill = "degeneration"
            useLoop = true
            loopBoost = canBoost
            venom = ""
        else
            -- Has timeloop, proceed with madness
            if not hasAsthma then
                venom = "kalmia"
            elseif not hasWeariness then
                venom = "vernalius"
            elseif not hasSlickness then
                venom = "gecko"
            elseif not hasAnorexia then
                venom = "slike"
            else
                venom = "eurypteria"
            end
        end
    
    -- Working toward hypochondria: have depression/nausea
    elseif hasDepression or hasNausea then
        -- Timeloop check handled at top now
        instill = "depression"
        if not hasAsthma then
            venom = "kalmia"
        elseif not hasSlickness then
            venom = "gecko"
        elseif not hasAnorexia then
            venom = "slike"
        else
            venom = "eurypteria"
        end
    
    -- Have justice + retribution: move to depression
    elseif hasJustice and hasRetribution then
        -- Timeloop check handled at top now
        instill = "depression"
        if not hasAsthma then
            venom = "kalmia"
        elseif not hasSlickness then
            venom = "gecko"
        else
            venom = "eurypteria"
        end
    
    -- Have timeloop but not full justice + retribution yet
    elseif hasTimeloop and not (hasJustice and hasRetribution) then
        instill = "retribution"
        venom = "curare"  -- Already have timeloop, just use venom
    
    -- Uncertain about timeloop in retribution phase - check with retribution + venom
    elseif uncertainLoop and (hasJustice or hasRetribution) then
        instill = "retribution"
        venom = "curare"  -- Progress retribution while checking loop status
    
    -- Have timeloop, justice, retribution: need asthma before depression
    elseif hasTimeloop and hasJustice and hasRetribution and not hasAsthma then
        instill = "degeneration"
        venom = "kalmia"  -- Degen gives para (if clum+wear), venom gives asthma
    
    -- Lost timeloop after progressing: this should be caught by early check, but keep as fallback
    elseif not hasTimeloop and (hasJustice or hasRetribution or hasDepression) then
        -- We've progressed but lost timeloop - this is a fallback safety net
        -- Should mostly be handled by the early recovery block above
        if hasClumsy and hasWeariness and canLoop then
            -- Have prerequisites, reapply loop with appropriate instill for phase
            if hasJustice or hasRetribution then
                instill = "retribution"
            else
                instill = "degeneration"
            end
            if not uncertainLoop then
                useLoop = true
                loopBoost = canBoost
                venom = ""
            else
                venom = "curare"
            end
        else
            -- Can't loop or missing prerequisites, build them
            instill = "degeneration"
            venom = "curare"
        end
    
    -- Ready to stick timeloop: have clumsy/weariness but NO timeloop yet
    elseif not hasTimeloop and (hasClumsy and hasWeariness) and canLoop and not uncertainLoop then
        -- Both clum + wear present, use loop to stick timeloop
        instill = "degeneration"
        useLoop = true
        loopBoost = canBoost  -- Only boost if age = 0
        venom = ""
    
    elseif not hasTimeloop and (hasClumsy or hasWeariness) and canBoost and not uncertainLoop then
        -- Only one present but we can boost - boost to get both + para + loop
        instill = "degeneration"
        useLoop = true
        loopBoost = true
        venom = ""
    
    -- Uncertain about loop in early phase - check with degeneration + venom
    elseif uncertainLoop and (hasClumsy or hasWeariness) then
        instill = "degeneration"
        venom = "curare"  -- Build affs while checking loop status
    
    -- Building toward timeloop: need clumsy/weariness first
    else
        instill = "degeneration"
        venom = "curare"
    end
    
    -- BUILD ATTACK STRING
    if useLoop and loopBoost then
        -- Loop boost
        atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop boost::shadow reap "..target.."::assess "..target.."::contemplate "..target
    elseif useLoop then
        -- Regular loop (no boost)
        atkstr = atkstr.."shadow instill scythe with "..instill.."::chrono loop::shadow reap "..target.."::assess "..target.."::contemplate "..target
    else
        -- Normal attack with venom
        atkstr = atkstr.."shadow instill scythe with "..instill.."::shadow reap "..target.." "..venom.."::assess "..target.."::contemplate "..target
    end
    
    send("setalias att "..atkstr)
    send("queue addclear freestand att")
end